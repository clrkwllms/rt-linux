#!/bin/sh
#
# Export all branches to quilt queues for archiving
#

. ~/bin/tip/tip-lib

check_master

[ -e tip/ ] && { echo "tip/ hierarchy already exists!"; exit -1; }

BS=`get_auto_branches master`

for N in $(git-branch | cut -c2- | grep -vE ' master$| base$| tmp|for-linus'); do

  # Exclude autogenerated branches
  EXP=1
  for B in $BS; do
    if [ "$B" == "$N" ]; then 
      EXP=0; 
      break;
    fi
  done

  if [ $EXP -eq 0 ]; then continue; fi

  ITEMS=$(git-rev-list --reverse base..$N)
  mkdir -p tip/$N
  echo $N

  echo > tip/$N/series
  for M in $ITEMS; do
    git-show --pretty=email --no-merges $M > tip/$N/$M
    # | tail -n +2 | sed 's/^Author: /From: /'

    # pure merges will be zero-size patches:
    [ -s tip/$N/$M ] && echo $M >> tip/$N/series

  done

#  # delete empty branches:
#  [ -s $N/series ] || rm -rf $N

done

